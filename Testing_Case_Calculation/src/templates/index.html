<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">    
    <style>
        #device_model_selector {
            margin: 10px;
            margin-top: 50px;
        }

        #device_model_header {
            padding-right: 20px;
        }

        .spec_test_plan {
            margin: 10px;
            border: 1px black solid;
        }

        #test_items_form {
            margin-top: 50px;
            margin-left: 150px;
            border: 1px black solid;
            width: 350px;
            height: 500px;
            overflow: auto;
        }

        #select_movement {
            margin-top: 50px;
            border: 1px black solid;
            width: 50px;
            height: 150px;
        }

        #selected_form {
            margin-top: 50px;
            margin-right: 150px;
            border: 1px black solid;
            width: 350px;
            height: 500px;
            overflow: auto;
        }

        .export_area {
            margin: 30px;
        }

        #export_button {
        }

        #export_descrp {
        }
    </style>
    <script type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

        var SpecObject = null;
        var TestingSpecType = null;
        var SpecTestingTimer = {};
        var SpecTestingTimerId = 0;

        window.onload = function() {
            SpecObject = new SpecTestingTime();
            SpecObject.init();
            SpecObject.getSpecDeviceModels();
        };


        window.onclick = function() {

            $("button.test_plan").click(function(event) {
                /*
                 * Click 'Spec Type' buttom
                 */
                 SpecObject.specOnClick(event);
            });

            $("#select_movement_right").unbind().click(function() {
                /*
                 * Click 'OK' buttom
                 * 
                 * Note:
                 *    One click trigger click-event multiple times.
                 *    Answer at StackOverFlow:
                 *    https://stackoverflow.com/questions/14969960/jquery-click-events-firing-multiple-times
                 */
                console.log("Selected and saved the setting with specific device mmodule.");
                SpecObject.saveSpecTestingTimeCalculationSetting();
            });
            
            $("#select_movement_left").unbind().click(function(event) {
                /*
                 * Click 'Back to Edit' buttom
                 */
                console.log("Back the setting edit step.");
                SpecObject.backToEditor();
            });
            
            $("#export_report").unbind().click(function(event) {
                /*
                 * Click 'Export Report' buttom
                 */
                console.log("Export report with target spec testing items.");
                // Do something hanlding.
                var target = JSON.stringify(SpecTestingTimer);
                SpecObject.exportSpecTestingTimeReport(target);
            });
            
        };


        function SpecTestingTime() {};


        SpecTestingTime.prototype.init = function() {
            // Set headers of table which display target testing items with specific device module
            $("thead#target_test_items_form_theader").append("<th scope='col'></th><th scope='col'> Index </th><th scope='col'> Device Module </th><th scope='col'> Testing Spec Type </th>");
        }
        

        SpecTestingTime.prototype.specOnClick = function(event) {
            var self = this;
            TestingSpecType = $(event.target).val()
            var device_model = $("select#device_model :selected").val();
            self.getSpecItemsTestingTime(TestingSpecType, device_model);
        }


        SpecTestingTime.prototype.getSpecDeviceModels = function () {
            $.ajax({
                url: "/api/v1/deviceModels", 
                type: "GET", 
                success: function(response) {
                    $.each(response, function(index, model) {
                        $("#device_model").append("<option value='" + model + "'>" + model + "</option>");
                    });
                },
                error: function(xhr) {
                    console.log("Occur somemthing unexpected error ...");
                }
            });
        }


        SpecTestingTime.prototype.getSpecItemsTestingTime = function(spec_type, device_model) {
            var self = this;
            $.ajax({
                url: "/api/v1/testing-time", 
                type: "POST", 
                data: {
                    spec: spec_type, 
                    deviceModel: device_model
                }, 
                success: function(response) {
                    self.displayTestItemsTestingTime(response);
                },
                error: function(xhr) {
                    console.log("Occur somemthing unexpected error ...");
                }
            });
        }


        SpecTestingTime.prototype.displayTestItemsTestingTime = function(response) {
            var self = this;
            // Clean all things in the area
            $("thead#test_items_form_theader").empty();
            $("tbody#test_items_form_tbody").empty();
            
            // Set table headers
            $("thead#test_items_form_theader").append("<th scope='col'> Selected </th><th scope='col'> Test Item </th><th scope='col'> Testing Time </th>");

            // Set table data
            $.each(response, function(index, value) {
                $("tbody#test_items_form_tbody").append("<tr><th scope='row'><input type='checkbox' class='test_item' value='" + self.asJsonType(index, value) + "'></th><td>" + index + "</td><td>" + value + "</td></tr>");
            });
        }


        SpecTestingTime.prototype.asJsonType = function(index, value) {
            var testing_item = index.replaceAll(' ', '_');
            return '{"' + testing_item + '": ' + value + '}';
        }


        SpecTestingTime.prototype.saveSpecTestingTimeCalculationSetting = function() {debugger
            // Read the setting of specific device, spec and testing items.
            var spec_type = TestingSpecType;
            var device_model = $("select#device_model :selected").val();
            var testing_items = new Array;
            $("input:checkbox[class=test_item]:checked").each(function() {
                testing_items.push(JSON.parse(JSON.stringify($(this).val())));
            });

            // Convert to JSON data
            // Method 1
            var testing_item_info = {
                device_model: device_model,
                spec_type: spec_type,
                items: JSON.parse(JSON.stringify(testing_items))
            };
            // Method 2
            // var testing_item_info = {}
            // testing_item_info.device_model = device_model;
            // testing_item_info.spec_type = spec_type;
            // testing_item_info.items = JSON.parse(JSON.stringify(testing_items));
            
            // Persistent the setting to the variable
            // Note: Should use closure to saving data to be more clear and saver.
            var SpecSettingItemId = "spec_testing_time_" + SpecTestingTimerId
            // Check the target device module and spec type weather is duplicated or not.
            if (SpecTestingTimerId > 0) {
                for (let index = 0; index < SpecTestingTimerId; index ++) {
                    var allJsonData = JSON.parse(JSON.stringify(SpecTestingTimer));
                    var jdata = JSON.parse(JSON.stringify(allJsonData["spec_testing_time_" + index]));
                    if ((jdata.device_model == device_model) && (jdata.spec_type == spec_type)) {
                        alert("The device module and Spec type you selected is duplicated. Please edit it, doesn't create it again.");
                        return ;
                    }
                }
            }
            // Save into object
            SpecTestingTimer[SpecSettingItemId] = testing_item_info;

            // Set table data
            $("tbody#target_test_items_form_tbody").append("<tr><th scope='row'><input type='checkbox' class='test_item' value='" + SpecSettingItemId + "'><th scope='row'><span>" + SpecTestingTimerId + "</span></th><td>" + device_model + "</td><td>" + spec_type + "</td></tr>");

            // Add the ID value
            SpecTestingTimerId += 1;
        }


        SpecTestingTime.prototype.backToEditor = function() {
            /*
             * Note: (Not implement)
             *     Back to edit step to review or edit the setting with specific device module & spec type
             */
        }

        
        SpecTestingTime.prototype.exportSpecTestingTimeReport = function(target_setting) {
            /*
             * Note:
             * Refer to URL https://www.aspsnippets.com/Articles/Download-File-in-AJAX-Response-Success-using-jQuery.aspx
             */
            $.ajax({
                url: "/api/v1/export-testing-time-result", 
                type: "POST", 
                data: {
                    target: target_setting
                },
                cache: false,
                xhr: function () {
                    var xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 2) {
                            if (xhr.status == 200) {
                                xhr.responseType = "blob";
                            } else {
                                xhr.responseType = "text";
                            }
                        }
                    };
                    return xhr;
                },
                success: function(response) {
                    const blob = new Blob([response], {type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;"});
                    const downloadUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = "D-Link_Wi-Fi_Testing_Time_Report_.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },
                error: function(xhr) {
                    console.log(xhr);
                    console.log("Occur somemthing unexpected error ...");
                }
            });
        }
    
    </script>
</head>
<body>
    <div class="container">
        <div class="row" id="device_model_selector">
            <span id="device_model_header">Device Model: </span><select id="device_model">
                <option value=""> ---請選擇機器型號--- </option>
            </select>
        </div>

        <div class="row">
            <!--
            <div class="col spec_test_plan">
                <span class="testing_group" id="full_test">Full Test</span>
            </div>

            <div class="col spec_test_plan">
                <span class="testing_group" id="regression_test">Regression Test</span>
            </div>

            <div class="col spec_test_plan">
                <span class="testing_group" id="easy_test">Easy Test</span>
            </div>

            <div class="col spec_test_plan">
                <span class="testing_group" id="sampling_test">Sampling Test</span>
            </div>
            -->
            <div class="col spec_test_plan">
                <label id="">
                    <!-- <span> Full Test </span><input type="checkbox" value="Export Report"> -->
                    <button type="button" class="test_plan btn btn-default btn-lg" value="full_test"> Full Test </button>
                </label>
            </div>

            <div class="col spec_test_plan">
                <label id="">
                    <!-- <span> Regression Test </span><input type="radio" value="Export Report"> -->
                    <button type="button" class="test_plan btn btn-default btn-lg" value="regression_test"> Regression Test </button>
                </label>
            </div>

            <div class="col spec_test_plan">
                <label id="">
                    <!-- <span> Easy Test </span><input type="radio" value="Export Report"> -->
                    <button type="button" class="test_plan btn btn-default btn-lg" value="easy_test"> Easy Test </button>
                </label>
            </div>

            <div class="col spec_test_plan">
                <label id="">
                    <!-- <span> Sampling Test </span><input type="radio" value="Export Report"> -->
                    <button type="button" class="test_plan btn btn-default btn-lg" value="sampling_test"> Sampling Test </button>
                </label>
            </div>
        </div>

        <div class="row justify-content-around align-items-center">
            <div class="col">
                <div id="test_items_form">
                    <table id="test_items_form_table" class="table">
                        <thead id="test_items_form_theader"></thead>
                        <tbody id="test_items_form_tbody"></tbody>
                    </table>
                </div>
            </div>

            <div class="col align-self-center" id="select_movement">
                <div id="select_movement_right">
                    <img src="{{ url_for('static', filename='images/arrow-from-right.png') }}" style="width: 50px; height: 65px;">
                </div>
                <div id="select_movement_left">
                    <img src="{{ url_for('static', filename='images/arrow-from-left.png') }}" style="width: 50px; height: 65px;">
                </div>
            </div>

            <div class="col">
                <div id="selected_form">
                    <table id="target_test_items_form_table" class="table">
                        <thead id="target_test_items_form_theader"></thead>
                        <tbody id="target_test_items_form_tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="export_area">
            <div class="row justify-content-around align-items-center" id="export_button">
                <label id="export_report">
                    <input type="button" value="Export Report">
                </label>
            </div>

            <div class="row" id="export_descrp">
                <div>Description: </div>
            </div>
        </div>
    </div>
</body>
</html>
